{"ast":null,"code":"import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import _toConsumableArray from\"C:/Users/HO_CHUN_WEI/Desktop/web/Jose-Antonio_LoverBus/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectWithoutProperties from\"C:/Users/HO_CHUN_WEI/Desktop/web/Jose-Antonio_LoverBus/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";import _slicedToArray from\"C:/Users/HO_CHUN_WEI/Desktop/web/Jose-Antonio_LoverBus/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useRef,useState}from\"react\";import{useQuery,useMutation}from'@apollo/react-hooks';import mapboxgl from\"mapbox-gl\";import*as MapboxGeocoder from'@mapbox/mapbox-gl-geocoder';import{Button}from'antd';import\"./site.css\";import env from\"react-dotenv\";import{// for query\nMARKER_QUERY// for mutation\n// ADD_MARKER_MUTATION,\n// DELETE_MARKER_MUTATION,\n// UPDATE_MARKER_MUTATION,\n// for subscription\n,MARKERS_SUBSCRIPTION}from'../graphql';mapboxgl.accessToken=process.env.REACT_APP_ACCESS_TOKEM;var MapBox=function MapBox(_ref){var username=_ref.username,markerCallback=_ref.markerCallback,insertionMode=_ref.insertionMode,setInsertionMode=_ref.setInsertionMode,title=_ref.title,setTitle=_ref.setTitle,description=_ref.description,setDescription=_ref.setDescription;var _useState=useState({lng:121.55,lat:25.05,zoom:12}),_useState2=_slicedToArray(_useState,2),View=_useState2[0],setView=_useState2[1];var _useQuery=useQuery(MARKER_QUERY,{variables:{username:username}}),subscribeMarker=_useQuery.subscribeMarker,markers=_objectWithoutProperties(_useQuery,[\"subscribeMarker\"]);// const [insertionMode, setInsertionMode] = useState(false)\nvar _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),map=_useState4[0],setMap=_useState4[1];var mapContainer=useRef(null);var _useQuery2=useQuery(MARKER_QUERY,{variables:{username:username}}),data=_useQuery2.data,subscribeToMore=_useQuery2.subscribeToMore;var _useState5=useState(null),_useState6=_slicedToArray(_useState5,2),currentMarker=_useState6[0],_setCurrentMarker=_useState6[1];var setCurrentMarker=function setCurrentMarker(e){_setCurrentMarker(e);markerCallback(e);};var _useState7=useState(0),_useState8=_slicedToArray(_useState7,2),test=_useState8[0],setTest=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),markerLoaded=_useState10[0],setMarkerLoaded=_useState10[1];useEffect(function(){var initializeMap=function initializeMap(_ref2){var setMap=_ref2.setMap,mapContainer=_ref2.mapContainer;var map=new mapboxgl.Map({container:mapContainer.current,style:\"mapbox://styles/mapbox/streets-v11\",// stylesheet location\ncenter:[View.lng,View.lat],zoom:View.zoom});map.on(\"move\",function(){setView({lng:map.getCenter().lng.toFixed(4),lat:map.getCenter().lat.toFixed(4),zoom:map.getZoom().toFixed(2)});setTest(4);});map.on(\"load\",function(){setMap(map);map.resize();});var geocoder=new MapboxGeocoder({accessToken:mapboxgl.accessToken,mapboxgl:mapboxgl});map.geocoder=geocoder;map.addControl(geocoder);// map.addControl(\n//     new MapboxGeocoder({\n//     accessToken: mapboxgl.accessToken,\n//     mapboxgl: mapboxgl\n//     })\n// );  \n};if(!map)initializeMap({setMap:setMap,mapContainer:mapContainer});},[map]);useEffect(function(){if(!map)return;map.geocoder.on(\"result\",function(){if(currentMarker){if(currentMarker.geocoderResult||insertionMode){currentMarker.remove();}}setInsertionMode(false);setTitle(JSON.parse(map.geocoder.lastSelected).place_name);var linLat=map.geocoder.mapMarker._lngLat;map.geocoder.mapMarker.remove();var marker=new mapboxgl.Marker().setLngLat(linLat).addTo(map);marker.geocoderResult=true;setCurrentMarker(marker);});},[map,currentMarker]);useEffect(function(){if(map&&insertionMode){var clickPoint=function clickPoint(e){if(currentMarker)currentMarker.remove();var marker=new mapboxgl.Marker().setLngLat([e.lngLat.lng,e.lngLat.lat]).addTo(map);setTitle(\"\");setDescription(\"\");setCurrentMarker(marker);};map.once('click',clickPoint);return function(){map.off('click',clickPoint);};}// else if(map && !insertionMode && currentMarker){\n//     currentMarker.remove()\n//     setCurrentMarker(null)\n// }\n},[map,insertionMode,currentMarker]);if(map&&data&&!markerLoaded){setMarkerLoaded(true);data.Marker.map(function(e){var linLat=e.geometry.coordinates;var popup=new mapboxgl.Popup().setHTML(\"<h3>\".concat(e.properties.title,\"<h3><p>\").concat(e.properties.description,\"</p>\"));var marker=new mapboxgl.Marker().setLngLat(linLat).setPopup(popup).addTo(map);marker._id=e._id;marker.getElement().addEventListener('click',function(){setCurrentMarker(marker);setTitle(e.properties.title);setDescription(e.properties.description);});});}useEffect(function(){if(!subscribeToMore||!map)return;subscribeToMore({document:MARKERS_SUBSCRIPTION,variables:{username:username},updateQuery:function updateQuery(prev,_ref3){var subscriptionData=_ref3.subscriptionData;var newData=subscriptionData.data.subscribeMarker;switch(newData.mutation){case\"NEW\":var linLat=newData.data.geometry.coordinates;var popup=new mapboxgl.Popup().setHTML(\"<h3>\".concat(newData.data.properties.title,\"<h3><p>\").concat(newData.data.properties.description,\"</p>\"));var marker=new mapboxgl.Marker().setLngLat(linLat).setPopup(popup).addTo(map);marker._id=newData.data._id;marker.getElement().addEventListener('click',function(){setCurrentMarker(marker);setTitle(newData.data.properties.title);setDescription(newData.data.properties.description);});return{Marker:[].concat(_toConsumableArray(prev.Marker),[newData.data])};break;case\"DELETE\":return{Marker:prev.Marker.filter(function(e){return e._id!==newData.data._id;})};case\"UPDATE\":return{Marker:prev.Marker.map(function(e){if(e._id!==newData.data._id)return e;return newData.data;})};break;default:console.log(\"Warning: unknown mutation \".concat(newData.mutation));break;}}});},[map]);var buttonOnclick=function buttonOnclick(){if(currentMarker&&(insertionMode||currentMarker.geocoderResult)){currentMarker.remove();}setCurrentMarker(null);setInsertionMode(!insertionMode);};var color=insertionMode?\"green\":\"white\";return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{className:\"sidebarStyle\",children:/*#__PURE__*/_jsxs(\"div\",{children:[\"Longitude: \",View.lng,\" | Latitude: \",View.lat,\" | Zoom: \",View.zoom,\" \"]})}),/*#__PURE__*/_jsx(Button,{style:{position:\"relative\",right:\"0px\",\"background-color\":color},onClick:buttonOnclick,children:\"+\"}),/*#__PURE__*/_jsx(\"div\",{ref:function ref(el){return mapContainer.current=el;},className:\"mapContainer\"})]});};export default MapBox;","map":{"version":3,"sources":["C:/Users/HO_CHUN_WEI/Desktop/web/Jose-Antonio_LoverBus/src/components/Mapbox_TW.js"],"names":["React","useEffect","useRef","useState","useQuery","useMutation","mapboxgl","MapboxGeocoder","Button","env","MARKER_QUERY","MARKERS_SUBSCRIPTION","accessToken","process","REACT_APP_ACCESS_TOKEM","MapBox","username","markerCallback","insertionMode","setInsertionMode","title","setTitle","description","setDescription","lng","lat","zoom","View","setView","variables","subscribeMarker","markers","map","setMap","mapContainer","data","subscribeToMore","currentMarker","_setCurrentMarker","setCurrentMarker","e","test","setTest","markerLoaded","setMarkerLoaded","initializeMap","Map","container","current","style","center","on","getCenter","toFixed","getZoom","resize","geocoder","addControl","geocoderResult","remove","JSON","parse","lastSelected","place_name","linLat","mapMarker","_lngLat","marker","Marker","setLngLat","addTo","clickPoint","lngLat","once","off","geometry","coordinates","popup","Popup","setHTML","properties","setPopup","_id","getElement","addEventListener","document","updateQuery","prev","subscriptionData","newData","mutation","filter","console","log","buttonOnclick","color","position","right","el"],"mappings":"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","sourcesContent":["import React, { useEffect, useRef, useState } from \"react\";\r\nimport { useQuery, useMutation } from '@apollo/react-hooks'\r\nimport mapboxgl from \"mapbox-gl\";\r\nimport * as MapboxGeocoder from '@mapbox/mapbox-gl-geocoder';\r\nimport { Button } from 'antd';\r\nimport \"./site.css\"\r\nimport env from \"react-dotenv\";\r\n\r\nimport {\r\n// for query\r\nMARKER_QUERY,\r\n// for mutation\r\n// ADD_MARKER_MUTATION,\r\n// DELETE_MARKER_MUTATION,\r\n// UPDATE_MARKER_MUTATION,\r\n// for subscription\r\nMARKERS_SUBSCRIPTION\r\n} from '../graphql'\r\n\r\nmapboxgl.accessToken = process.env.REACT_APP_ACCESS_TOKEM\r\nconst MapBox = ({username, markerCallback, insertionMode, setInsertionMode, title, setTitle, description, setDescription}) => {\r\n    \r\n    const [View, setView] = useState({\r\n        lng: 121.55,\r\n        lat: 25.05,\r\n        zoom: 12\r\n    })\r\n    const { subscribeMarker, ...markers } = useQuery(\r\n        MARKER_QUERY,\r\n        { variables: { username: username } }\r\n        )\r\n    // const [insertionMode, setInsertionMode] = useState(false)\r\n\r\n\r\n    const [map, setMap] = useState(null);\r\n    const mapContainer = useRef(null);\r\n    const {data, subscribeToMore} = useQuery(MARKER_QUERY, {variables:{username: username}})\r\n\r\n    const [currentMarker, _setCurrentMarker] = useState(null);\r\n    const setCurrentMarker = e => {_setCurrentMarker(e); markerCallback(e);} \r\n    const [test, setTest] = useState(0);\r\n    const [markerLoaded, setMarkerLoaded] = useState(false);\r\n\r\n    useEffect(() => {\r\n        const initializeMap = ({ setMap, mapContainer}) => {\r\n            const map = new mapboxgl.Map({\r\n                container: mapContainer.current,\r\n                style: \"mapbox://styles/mapbox/streets-v11\", // stylesheet location\r\n                center: [View.lng, View.lat],\r\n                zoom: View.zoom\r\n                });\r\n\r\n            map.on(\"move\", () => {\r\n                setView({lng: map.getCenter().lng.toFixed(4), lat: map.getCenter().lat.toFixed(4), zoom:map.getZoom().toFixed(2)})\r\n                setTest(4)\r\n            });\r\n\r\n            map.on(\"load\", () => {\r\n                setMap(map);\r\n                map.resize();\r\n            });\r\n\r\n            var geocoder = new MapboxGeocoder({\r\n                accessToken: mapboxgl.accessToken,\r\n                mapboxgl: mapboxgl\r\n            })\r\n            map.geocoder = geocoder\r\n            map.addControl(geocoder)\r\n            // map.addControl(\r\n            //     new MapboxGeocoder({\r\n            //     accessToken: mapboxgl.accessToken,\r\n            //     mapboxgl: mapboxgl\r\n            //     })\r\n            // );  \r\n\r\n        }\r\n        if (!map) initializeMap({ setMap, mapContainer});\r\n    }, [map]);\r\n\r\n    useEffect(()=>{\r\n        if(!map) return\r\n        map.geocoder.on(\"result\", ()=>{\r\n            if(currentMarker){\r\n                if(currentMarker.geocoderResult || insertionMode){\r\n                    currentMarker.remove()\r\n                }\r\n            }\r\n            setInsertionMode(false)\r\n            setTitle(JSON.parse(map.geocoder.lastSelected).place_name)\r\n            const linLat = map.geocoder.mapMarker._lngLat\r\n            map.geocoder.mapMarker.remove()\r\n\r\n            var marker = new mapboxgl.Marker()\r\n            .setLngLat(linLat)\r\n            .addTo(map)\r\n\r\n            marker.geocoderResult = true\r\n            setCurrentMarker(marker)\r\n        })\r\n    },[map, currentMarker])\r\n\r\n    useEffect(()=>{\r\n        if(map && insertionMode){\r\n            const clickPoint = (e) => {\r\n                if(currentMarker) currentMarker.remove()\r\n\r\n                var marker = new mapboxgl.Marker()\r\n                .setLngLat([e.lngLat.lng, e.lngLat.lat])\r\n                .addTo(map)\r\n\r\n                setTitle(\"\")\r\n                setDescription(\"\")\r\n                \r\n                setCurrentMarker(marker)\r\n            };\r\n            map.once('click', clickPoint);\r\n            return ()=>{map.off('click', clickPoint);}\r\n        }\r\n        // else if(map && !insertionMode && currentMarker){\r\n        //     currentMarker.remove()\r\n        //     setCurrentMarker(null)\r\n        // }\r\n    }, [map, insertionMode, currentMarker]);\r\n\r\n    if(map && data && !markerLoaded){\r\n        setMarkerLoaded(true)\r\n        data.Marker.map(e=>{\r\n            const linLat = e.geometry.coordinates\r\n            var popup = new mapboxgl.Popup()\r\n            .setHTML(`<h3>${e.properties.title}<h3><p>${e.properties.description}</p>`);\r\n\r\n            var marker = new mapboxgl.Marker()\r\n            .setLngLat(linLat)\r\n            .setPopup(popup)\r\n            .addTo(map)\r\n\r\n            marker._id = e._id\r\n\r\n            marker.getElement().addEventListener('click', () => {\r\n                    setCurrentMarker(marker)\r\n                    setTitle(e.properties.title)\r\n                    setDescription(e.properties.description)\r\n                });\r\n        })\r\n    }\r\n\r\n    useEffect(()=>{\r\n        if(!subscribeToMore || !map) return;\r\n        subscribeToMore({\r\n            document: MARKERS_SUBSCRIPTION,\r\n            variables: {username: username},\r\n            updateQuery: (prev, { subscriptionData }) => {\r\n                const newData = subscriptionData.data.subscribeMarker\r\n                switch(newData.mutation){\r\n                    case \"NEW\":\r\n                        const linLat = newData.data.geometry.coordinates\r\n                        var popup = new mapboxgl.Popup()\r\n                        .setHTML(`<h3>${newData.data.properties.title}<h3><p>${newData.data.properties.description}</p>`);\r\n\r\n                        var marker = new mapboxgl.Marker()\r\n                        .setLngLat(linLat)\r\n                        .setPopup(popup)\r\n                        .addTo(map)\r\n\r\n                        marker._id = newData.data._id\r\n\r\n                        marker.getElement().addEventListener('click', () => {\r\n                            setCurrentMarker(marker)\r\n                            setTitle(newData.data.properties.title)\r\n                            setDescription(newData.data.properties.description)\r\n                        });\r\n                        return {Marker:[...prev.Marker, newData.data]}\r\n                    break\r\n                    case \"DELETE\":\r\n                        return {Marker: prev.Marker.filter(e=>e._id !== newData.data._id)}\r\n                    case \"UPDATE\":\r\n                        return {Marker: prev.Marker.map(e=>{\r\n                            if(e._id !== newData.data._id)\r\n                                return e\r\n                            return newData.data\r\n                        })}\r\n                    break\r\n                    default:\r\n                        console.log(`Warning: unknown mutation ${newData.mutation}`)\r\n                    break\r\n                }\r\n            }\r\n        })\r\n    }, [map])\r\n\r\n    const buttonOnclick = () => {\r\n        if (currentMarker && (insertionMode || currentMarker.geocoderResult)){\r\n            currentMarker.remove()\r\n        }\r\n        setCurrentMarker(null)\r\n        setInsertionMode(!insertionMode)\r\n    }\r\n    const color = insertionMode? \"green\" : \"white\"\r\n    return (\r\n        <div>\r\n            <div className='sidebarStyle'>\r\n                <div>Longitude: {View.lng} | Latitude: {View.lat} | Zoom: {View.zoom} </div>\r\n            </div>\r\n            <Button style={{position: \"relative\", right: \"0px\",\"background-color\":color}}\r\n             onClick={buttonOnclick}>+</Button>\r\n            <div ref={el => (mapContainer.current = el)} className='mapContainer' />\r\n        </div>)\r\n}\r\n\r\nexport default MapBox"]},"metadata":{},"sourceType":"module"}